/**
 * –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø —Å–æ–∑–¥–∞–Ω–∏—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
 */

const BaseState = require('./baseState');
const config = require('../../../utils/config');
const logger = require('../../../utils/logger');
const sheetsService = require('../../../services/sheets');
const WeeklyReport = require('../../../services/sheets/models/WeeklyReport');

class ReportState extends BaseState {
  /**
   * –°–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞
   */
  constructor() {
    super(config.states.ENTERING_STATE);
    
    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –æ—Ü–µ–Ω–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è
    this.minStateValue = 1;
    this.maxStateValue = 10;
  }

  /**
   * –í—Ö–æ–¥–∏—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞
   * @param {Object} context - –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @returns {Promise<void>}
   */
  async enter(context) {
    logger.info(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${context.userId} –≤–æ—à–µ–ª –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –Ω–∞—á–∞—Ç—ã–π –æ—Ç—á–µ—Ç
    const existingReport = context.weeklyReport;
    
    if (existingReport) {
      // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞—á–∞—Ç—ã–π –æ—Ç—á–µ—Ç, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º, —Ö–æ—á–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –µ–≥–æ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
      await this._sendInlineKeyboard(
        context,
        '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–∞—á–∞—Ç—ã–π –æ—Ç—á–µ—Ç. –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –µ–≥–æ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π?',
        [
          [
            { text: '‚úèÔ∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å', callback_data: 'report_continue' },
            { text: 'üÜï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π', callback_data: 'report_new' }
          ]
        ]
      );
    } else {
      // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∞—á–∞—Ç–æ–≥–æ –æ—Ç—á–µ—Ç–∞, –Ω–∞—á–∏–Ω–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
      await this._startNewReport(context);
    }
  }

  /**
   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞
   * @param {Object} context - –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @param {Object} message - –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @returns {Promise<string|null>} - –°–ª–µ–¥—É—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–ª–∏ null
   */
  async handleMessage(context, message) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
    if (!message.text) {
      await this._sendMessage(
        context, 
        '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10, —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å –≤–∞—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.'
      );
      return null;
    }

    const text = message.text.trim();

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω—è–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
    if (text === '/cancel' || text.toLowerCase() === '–æ—Ç–º–µ–Ω–∞') {
      await this._cancelReport(context);
      return config.states.NONE;
    }

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ü–µ–Ω–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è
    const stateValue = parseInt(text, 10);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–≤–µ–¥–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ
    if (isNaN(stateValue) || stateValue < this.minStateValue || stateValue > this.maxStateValue) {
      await this._sendMessage(
        context,
        `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç ${this.minStateValue} –¥–æ ${this.maxStateValue}.`
      );
      return null;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ü–µ–Ω–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    context.weeklyReport.state = stateValue;
    await context.save();
    
    logger.info(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${context.userId} —É—Å—Ç–∞–Ω–æ–≤–∏–ª –æ—Ü–µ–Ω–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è: ${stateValue}`);

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É - –æ—Ç–º–µ—Ç–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
    return config.states.MARKING_TASKS;
  }

  /**
   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–ª–±—ç–∫-–∑–∞–ø—Ä–æ—Å—ã (–Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏)
   * @param {Object} context - –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @param {Object} query - –î–∞–Ω–Ω—ã–µ –∫–æ–ª–ª–±—ç–∫-–∑–∞–ø—Ä–æ—Å–∞
   * @returns {Promise<string|null>} - –°–ª–µ–¥—É—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–ª–∏ null
   */
  async handleCallbackQuery(context, query) {
    // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ –∫–æ–ª–ª–±—ç–∫, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    await this._answerCallbackQuery(context, query.id);
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –∫–æ–ª–ª–±—ç–∫–æ–≤
    switch (query.data) {
      case 'report_continue':
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –æ—Ç—á–µ—Ç–æ–º
        await this._sendMessage(
          context,
          '–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É —Å –Ω–∞—á–∞—Ç—ã–º –æ—Ç—á–µ—Ç–æ–º.\n\n' +
          '–°–µ–π—á–∞—Å –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –Ω–∞ —ç—Ç–∞–ø–µ –æ—Ü–µ–Ω–∫–∏ —Å–≤–æ–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è. ' +
          '–û—Ü–µ–Ω–∏—Ç–µ –≤–∞—à–µ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 10, –≥–¥–µ:\n\n' +
          '1-3 - –ø–ª–æ—Ö–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ üò¢\n' +
          '4-6 - —Å—Ä–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ üòê\n' +
          '7-9 - —Ö–æ—Ä–æ—à–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ üòä\n' +
          '10 - –æ—Ç–ª–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ü§©'
        );
        return null;
        
      case 'report_new':
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ—Ç—á–µ—Ç
        await this._startNewReport(context);
        return null;
        
      default:
        logger.warn(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–æ–ª–ª–±—ç–∫: ${query.data}`);
        return null;
    }
  }

  /**
   * –ù–∞—á–∏–Ω–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
   * @param {Object} context - –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @returns {Promise<void>}
   * @private
   */
  async _startNewReport(context) {
    try {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
      const today = new Date();
      const startOfYear = new Date(today.getFullYear(), 0, 1);
      const weekNumber = Math.ceil((((today - startOfYear) / 86400000) + startOfYear.getDay() + 1) / 7);
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –æ—Ç—á–µ—Ç–∞
      context.weeklyReport = new WeeklyReport({
        weekNumber,
        date: today,
        userId: context.userId,
        username: context.username || `user_${context.userId}`
      });
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
      await context.save();
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
      await this._sendMessage(
        context,
        '–ù–∞—á–∏–Ω–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞.\n\n' +
        '–°–Ω–∞—á–∞–ª–∞ –æ—Ü–µ–Ω–∏—Ç–µ –≤–∞—à–µ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 10, –≥–¥–µ:\n\n' +
        '1-3 - –ø–ª–æ—Ö–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ üò¢\n' +
        '4-6 - —Å—Ä–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ üòê\n' +
        '7-9 - —Ö–æ—Ä–æ—à–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ üòä\n' +
        '10 - –æ—Ç–ª–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ü§©\n\n' +
        '–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10.\n' +
        '\n' +
        '–î–ª—è –æ—Ç–º–µ–Ω—ã —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /cancel.'
      );
      
      logger.info(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${context.userId} –Ω–∞—á–∞–ª —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞`);
    } catch (error) {
      logger.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞: ${error.message}`, error);
      await this._sendMessage(
        context,
        '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
      );
    }
  }

  /**
   * –û—Ç–º–µ–Ω—è–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
   * @param {Object} context - –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @returns {Promise<void>}
   * @private
   */
  async _cancelReport(context) {
    // –£–¥–∞–ª—è–µ–º –æ—Ç—á–µ—Ç –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    delete context.weeklyReport;
    await context.save();
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ
    await this._sendMessage(
      context,
      '–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ.'
    );
    
    logger.info(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${context.userId} –æ—Ç–º–µ–Ω–∏–ª —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞`);
  }
}

module.exports = new ReportState(); 